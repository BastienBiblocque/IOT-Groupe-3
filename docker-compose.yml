version: '3.8'
services:
    mqtt:
        image: eclipse-mosquitto:2.0
        restart: unless-stopped
        volumes:
            - './mosquitto-data:/mosquitto'
        ports:
            - '1883:1883'
            - '9001:9001'
        command: 'mosquitto -c /mosquitto-no-auth.conf'

    zigbee2mqtt:
        container_name: zigbee2mqtt
        restart: unless-stopped
        image: koenkk/zigbee2mqtt
        volumes:
            - ./zigbee2mqtt-data:/app/data
            - /run/udev:/run/udev:ro
        ports:
            - 8080:8080
        environment:
            - TZ=Europe/Berlin
        devices:
            - /dev/ttyUSB0:/dev/ttyUSB0

    # Service pour MySQL
    mysql:
        image: mysql:8.0
        container_name: mysql
        environment:
          - MYSQL_ROOT_PASSWORD=rootpassword
          - MYSQL_DATABASE=temperatures_data
          - MYSQL_USER=iot
          - MYSQL_PASSWORD=iot
        ports:
          - "3306:3306"
        volumes:
          - mysql_data:/var/lib/mysql  # Volume pour persister les donn√©es
          - ./mysql-init:/docker-entrypoint-initdb.d
        healthcheck:
          test: ["CMD-SHELL", "mysqladmin ping -h localhost -u iot --password=iot || exit 1"]
          interval: 10s
          timeout: 5s
          retries: 10
          start_period: 30s

    subscriber:
      build:
        context: .
        dockerfile: Dockerfile.subscriber
      environment:
        - MQTT_BROKER=mosquitto
        - HTTP_ENDPOINT=http://backend:5000/api/temperature
        - DB_HOST=mysql
        - DB_PORT=3306
        - DB_USER=iot
        - DB_PASSWORD=iot
        - DB_NAME=temperatures_data
      depends_on:
        - mqtt
        - mysql:
          condition: service_healthy
      volumes:
        - .:/app
      healthcheck:
        test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
        interval: 30s
        timeout: 10s
        retries: 5
        start_period: 30s  
volumes: 
  mysql_data:
